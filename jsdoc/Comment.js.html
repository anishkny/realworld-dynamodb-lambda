<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: Comment.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: Comment.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const Util = require('./Util');
const User = require('./User');
const articlesTable = Util.getTableName('articles');
const commentsTable = Util.getTableName('comments');
const uuidv4 = require('uuid/v4');

/**
 * @module Comment
 */
module.exports = {

  /** Create comment */
  async create(event) {
    const authenticatedUser = await User.authenticateAndGetUser(event);
    if (!authenticatedUser) {
      return Util.envelop('Must be logged in.', 422);
    }

    const body = JSON.parse(event.body);
    if (!body.comment || !body.comment.body) {
      return Util.envelop('Comment must be specified.', 422);
    }
    const commentBody = body.comment.body;

    const slug = event.pathParameters.slug;
    const article = (await Util.DocumentClient.get({
      TableName: articlesTable,
      Key: { slug },
    }).promise()).Item;
    if (!article) {
      return Util.envelop(`Article not found: [${slug}]`, 422);
    }

    const timestamp = (new Date()).getTime();
    const comment = {
      id: uuidv4(),
      slug: slug,
      body: commentBody,
      createdAt: timestamp,
      updatedAt: timestamp,
      author: authenticatedUser.username,
    };

    await Util.DocumentClient.put({
      TableName: commentsTable,
      Item: comment,
    }).promise();

    comment.author = {
      username: authenticatedUser.username,
      bio: authenticatedUser.bio || '',
      image: authenticatedUser.image || '',
      following: false,
    };

    return Util.envelop({ comment });
  },

  /** Get comments for an article */
  async get(event) {
    const authenticatedUser = await User.authenticateAndGetUser(event);
    const slug = event.pathParameters.slug;

    const comments = (await Util.DocumentClient.query({
      TableName: commentsTable,
      IndexName: 'article',
      KeyConditionExpression: 'slug = :slug',
      ExpressionAttributeValues: {
        ':slug': slug,
      },
    }).promise()).Items;

    // Get profile for each comment's author
    for (let i = 0; i &lt; comments.length; ++i) {
      comments[i].author = await User.getProfileByUsername(comments[i].author,
        authenticatedUser);
    }

    return Util.envelop({ comments });
  },

  /** Delete comment */
  async delete(event) {
    const authenticatedUser = await User.authenticateAndGetUser(event);
    if (!authenticatedUser) {
      return Util.envelop('Must be logged in.', 422);
    }
    const commentId = event.pathParameters.id;

    const comment = (await Util.DocumentClient.get({
      TableName: commentsTable,
      Key: {
        id: commentId,
      },
    }).promise()).Item;
    if (!comment) {
      return Util.envelop(`Comment ID not found: [${commentId}]`, 422);
    }

    // Only comment author can delete comment
    if (comment.author !== authenticatedUser.username) {
      return Util.envelop(
        `Only comment author can delete: [${comment.author}]`, 422);
    }

    await Util.DocumentClient.delete({
      TableName: commentsTable,
      Key: {
        id: commentId,
      },
    }).promise();

    return Util.envelop({});
  },

};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Article.html">Article</a></li><li><a href="module-Comment.html">Comment</a></li><li><a href="module-User.html">User</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Tue Jun 15 2021 02:52:22 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
